# Logic Flow的插件系统

## 什么是插件？

wiki中这样定义的：插件（又译外挂，英文为plug-in、plugin、add-in、addin、add-on、addon或extension）是一种电脑程序，透过和应用程序（例如网页浏览器，电子邮件客户端）的互动，用来替应用程序增加一些所需要的特定的功能。最常见的有游戏、网页浏览器的插件和媒体播放器的插件。

应用程序之所以支持插件的使用原因很多，主要包括：使得第三方的开发者可以对应用程序进行扩充、精简，或者将源代码从应用程序中分离出来，去除因软件使用权限而产生的不兼容。

所以对于 Logic Flow 来说，什么是插件？

我觉得只要能通过 Logic Flow 对外暴露的API进行扩展开发出来的js， 就是插件。所以 Logic Flow 的插件系统说到底就是规范对外暴露API。

## 如何定义 Logic Flow 中的插件？

要给 Logic Flow 实现插件系统，那么首先我们需要明确边界。要想明确边界，则需要定义好 Logic Flow 的核心功能有哪些？我目前的理解是只有一个，那就是”流程图的编辑“。流程图外观可以千变万化，但是其核心编辑图形，应该是不变。所以其核心点有如下：

- 绘制图形到画布
- 连接多个图形
- 删除图形
- 调整图形位置和外观

目前，我们尽量暴露好外观相关的API, 不暴露操作相关的API。

当然，整个 Logic Flow 项目不能只有核心代码，我们需要提供大量配套的插件。甚至到了后期，内置的插件代码会比核心代码更多。可以参考webpack的插件模式，整个webpack，大概约80%的代码是以插件的形式进行开发的。

### 我们对外暴露什么API

#### 节点

目前 Logic Flow 内置了一个抽象类`BaseNode`, 和两个实现了`BaseNode`这个类的节点`RectNode`和`CircleNode`。

我们将`BaseNode`、`RectNode`和`CircleNode`对外暴露为API，这个API可以通过类的继承，来重他们public方法，来实现绘制自定义节点。

例如，我们有一个public方法是`getShapeConfigAttrs`返回当前节点的界面属性配置的，比如返回了宽，高，颜色等。同时，我们允许用户通过`property`属性，传入每个节点自己独特的属性，如大小，主题颜色等。那么，我们就可以通过重写`getShapConfigAttrs`方法，来实现判断当前节点属性大小、主题，返回不同的宽高、颜色。

详情请参考examples/custom-node.html

**节点暴露的public方法**

这个需要做统一定义暴露的API，下面的只是示例。

- getShapeConfigAttrs: 获取节点形状配置

- getTextConfigAttrs: 获取节点文本配置

- transConfigToAttrs: 转换坐标

- getAnchorPosition: 获取节点锚点列表

- createShape: 创建节点形状

#### 连线

方案同上面的节点，我们也可以通过重写edge来实现自定义连线

- getConnectConfigAttrs: 连接线配置

- getArrowConfig: 箭头配置

- getConnectionPoint: 获取连接线的相关点

- createConnectionShape: 绘制连接线

- getTextConfigAttrs: 获取节点文案配置

#### 锚点

- getAnchorConfig: 获取锚点基础配置

- addAnchor: 给图形增加锚点


#### 事件

todo

#### HTML层能力扩展

在插件的开发过程中，有这样一个问题，那就是我们的底层是svg， 而svg里面并不能增加html.
如果让插件的开发者同样使用svg来进行开发，即增加了开发的难度，又限制了插件的扩展性。
所以，我们在涉及到html相关的时候，我们在外部增加一个可以显示html的层, 叫做`HTML层`。

`HTML层`覆盖在`graph`上面，是一个`point-event:none`的HTMLElement。其坐标需要和`graph`一致（兼容graph的放大缩小）。


### 插件的生命周期

这个其实可以和 Logic Flow 的生命周期一起来看，目前还没有抽象出来。在目前的开发过程中，插件graph初始化之前注册，graph初始化的时候同步执行插件的init方法和实例化自定义节点。

目前操作`HTML层`的插件和自定义节点是不统一的。我们需要统一起来。需要将多个功能集合到一起。比如一个bpmn-js绘制风格的流程图，叫做`logic-flow-bpmn.js`, 用户再引入了这个js后，绘制的图就是整个bpmn风格的了。

1. 注册插件（提供一个registerNode和addPlugin的统一方法）
2. 卸载插件
3. 多个插件组合成一个插件



### 我们现在放到plugin中的菜单，缩放，拖入是插件吗？

菜单和拖入可以算作是插件，缩放不能算作是插件。
菜单可以看做是`HTML层`（这个可以稍后看多层overlay这个思路）提供的能力进行扩展。
拖入可以看做是暴露的事件API进行的扩展。
缩放不是，缩放会改变整体系统的坐标体系，这个能力不能成为对外暴露的API。

### 插件开发功能计划

1. bpmn风格的插件
2. process on中选两种流程图风格
3. 做一个看起来不像流程图的图




 




